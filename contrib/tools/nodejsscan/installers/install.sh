#!/bin/bash

# installs njsscan in $1

set -e
MYDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

INSTALL_DIR=$1

if [[ -z "$INSTALL_DIR" ]]; then
    echo "Missing an argument.
Usage: $0 directory-to-install-njsscan-in">&2
   exit 1
fi

function abspath() { pushd . > /dev/null; if [ -d "$1" ]; then cd "$1"; dirs -l +0; else cd "`dirname \"$1\"`"; cur_dir=`dirs -l +0`; if [ "$cur_dir" == "/" ]; then echo "$cur_dir`basename \"$1\"`"; else echo "$cur_dir/`basename \"$1\"`"; fi; fi; popd > /dev/null; }
INSTALL_DIR=$(abspath "$INSTALL_DIR")

mkdir -p "$INSTALL_DIR"
pip3 install -t "${INSTALL_DIR}" njsscan

BIN="${INSTALL_DIR}/bin/njsscan"
if [ ! -f "${BIN}" ]; then
    echo "ERROR: The installation of njsscan completed successfully, but ${BIN} does not exist?!">&2
    exit 1
fi
if [ ! -x "${BIN}" ]; then
    echo "ERROR: The installation of njsscan completed successfully, but ${BIN} is not executable?! ">&2
    exit 1
fi

MAIN="${MYDIR}/../../../../build/ts/contrib/tools/nodejsscan/src/nodejsscan.js"
MAIN=$(abspath "$MAIN")
echo "The njsscan tool has been installed. Add the fragment below to a config.json file:

{
  ...
  \"tools\": {
    ...

    \"nodejsscan-default\": {
      \"bin\": \"node\",
      \"args\": [ \"${MAIN}\" ],
      \"options\": {
        \"njsscanDir\": \"${INSTALL_DIR}\"
      }
    }

    ...
  }
  ...
}"
